<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æœ±è¿ªä¸å°¼å…‹çš„æ£‹å±€</title>
    
    <!-- iOS PWA Fullscreen Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-title" content="ZootopiaChess">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- å…¨å±€æ ·å¼ --- */
        body {
            font-family: 'Nunito', 'Noto Sans SC', system-ui, sans-serif;
            background: radial-gradient(circle at 50% 10%, #2b324d 0%, #151925 100%);
            color: #e2e8f0;
            overscroll-behavior: none;
            -webkit-user-select: none;
            user-select: none;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* 3D ç»ç’ƒæ‹Ÿæ€å¡ç‰‡ */
        .glass-panel {
            background: rgba(30, 41, 59, 0.75);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .btn-game {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .btn-game:active { transform: scale(0.95); }

        /* --- äº”å­æ£‹æ ·å¼ --- */
        .gobang-board {
            width: min(96vmin, calc(100vh - 200px));
            height: min(96vmin, calc(100vh - 200px));
            max-width: 900px; 
            max-height: 900px;
            background-color: #e6b87d;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), inset 0 0 60px rgba(66, 33, 10, 0.2);
            border-radius: 4px;
            border: 6px solid #6b4423; 
            position: relative;
            padding: 4px; 
            display: grid;
            grid-template-columns: repeat(15, 1fr);
            grid-template-rows: repeat(15, 1fr);
        }

        .gobang-cell {
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background-image: 
                linear-gradient(to right, transparent calc(50% - 1px), #5c3a1e calc(50% - 1px), #5c3a1e calc(50% + 1px), transparent calc(50% + 1px)),
                linear-gradient(to bottom, transparent calc(50% - 1px), #5c3a1e calc(50% - 1px), #5c3a1e calc(50% + 1px), transparent calc(50% + 1px));
        }

        .gobang-star-point {
            position: absolute;
            width: 16%; height: 16%;
            background-color: #5c3a1e;
            border-radius: 50%;
            z-index: 5;
            box-shadow: 0 1px 1px rgba(0,0,0,0.2);
        }

        .gobang-piece {
            width: 92%; height: 92%;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
            position: relative; z-index: 20; 
            box-shadow: 2px 4px 6px rgba(0,0,0,0.5), inset 2px 2px 5px rgba(255,255,255,0.3), inset -2px -2px 5px rgba(0,0,0,0.3);
            transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .gb-white { background: radial-gradient(circle at 35% 35%, #fff, #cbd5e1); color: #333; }
        .gb-black { background: radial-gradient(circle at 35% 35%, #475569, #0f172a); color: #fff; }
        .gb-orange { background: radial-gradient(circle at 35% 35%, #fb923c, #c2410c); color: #fff; text-shadow: 0 2px 2px rgba(0,0,0,0.3); }
        
        .last-move-marker::after {
            content: ''; position: absolute;
            width: 30%; height: 30%;
            background: rgba(239, 68, 68, 0.8);
            border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 6px rgba(239, 68, 68, 0.6);
        }

        /* --- å›½é™…è±¡æ£‹æ ·å¼ --- */
        .chess-board {
            width: min(96vmin, calc(100vh - 200px));
            height: min(96vmin, calc(100vh - 200px));
            max-width: 900px; max-height: 900px;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            border: 6px solid #334155;
            border-radius: 6px;
            box-shadow: 0 25px 60px -12px rgba(0, 0, 0, 0.7);
        }
        .chess-square { 
            position: relative; 
            /* é”å®šç½‘æ ¼å¤§å°ï¼Œé˜²æ­¢è¢«å¤§å°ºå¯¸ Emoji æ’‘å¼€ */
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chess-square.white { background-color: #e2e8f0; }
        .chess-square.black { background-color: #64748b; }
        
        .chess-square.selected { background-color: rgba(244, 63, 94, 0.6) !important; }
        
        /* ç§»åŠ¨è½¨è¿¹ä¼˜åŒ–ï¼š3ç§’åè‡ªåŠ¨æ¶ˆå¤± */
        @keyframes blink-fade-out {
            0% { box-shadow: inset 0 0 0 4px rgba(239, 68, 68, 0.4); background-color: rgba(239, 68, 68, 0.1); }
            50% { box-shadow: inset 0 0 0 4px rgba(239, 68, 68, 0.8); background-color: rgba(239, 68, 68, 0.25); }
            80% { box-shadow: inset 0 0 0 4px rgba(239, 68, 68, 0.4); background-color: rgba(239, 68, 68, 0.1); opacity: 1; }
            100% { box-shadow: none; background-color: transparent; opacity: 0; }
        }
        
        /* ä½¿ç”¨ä¼ªå…ƒç´ æ‰¿è½½åŠ¨ç”»ï¼Œé¿å…å½±å“å­å…ƒç´ å¸ƒå±€ */
        .chess-square.last-move::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 5;
            animation: blink-fade-out 3s ease-in-out forwards;
        }

        .hint-dot {
            position: absolute; width: 24%; height: 24%;
            background-color: rgba(34, 197, 94, 0.6);
            border-radius: 50%; top: 50%; left: 50%;
            transform: translate(-50%, -50%); z-index: 15;
            pointer-events: none;
        }
        .hint-capture {
            position: absolute; width: 85%; height: 85%;
            border: 4px solid rgba(239, 68, 68, 0.5);
            border-radius: 50%; top: 50%; left: 50%;
            transform: translate(-50%, -50%); z-index: 15; pointer-events: none;
        }

        /* æ£‹å­æ ·å¼ */
        .chess-piece {
            /* ä½¿ç”¨ Flex å±…ä¸­ï¼Œä¸å†ä¾èµ–å®½é«˜æ’‘æ»¡ï¼Œé˜²æ­¢åç§» */
            display: flex; 
            align-items: center; 
            justify-content: center;
            cursor: pointer; 
            z-index: 20;
            background: transparent !important;
            user-select: none;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            /* å­—ä½“å¤§å°å¾®è°ƒï¼Œä¿ç•™éœ‡æ’¼æ„Ÿä½†ç•™å‡ºè¾¹è· */
            font-size: clamp(2.2rem, 9vmin, 4.8rem);
            line-height: 1; /* å…³é”®ï¼šæ¶ˆé™¤å­—ä½“è‡ªå¸¦è¡Œé«˜å¯¼è‡´çš„å‚ç›´åç§» */
            width: 100%; 
            height: 100%;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .chess-piece.white-side {
            color: #f8fafc;
            text-shadow: 0px 2px 0px #94a3b8, 0 4px 8px rgba(0,0,0,0.4);
            filter: drop-shadow(0 0 1px rgba(0,0,0,0.5));
        }
        
        .chess-piece.black-side {
            color: #1e293b;
            text-shadow: 0px 2px 0px #000000, 0 4px 8px rgba(0,0,0,0.5);
        }

        /* å°¼å…‹ä¸“å±æ©™è‰²æ£‹å­ */
        .chess-piece.orange-side {
            color: #fb923c; 
            text-shadow: 0px 2px 0px #9a3412, 0 4px 8px rgba(0,0,0,0.4); 
            filter: drop-shadow(0 0 1px rgba(0,0,0,0.5));
        }

        .chess-piece:active { transform: scale(1.15) translateY(-5px); }

        /* ç‹ (Emoji) ç‰¹æ®Šä¿®æ­£ */
        .chess-emoji-king {
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
            /* ç¨å¾®å‡å° Emoji å°ºå¯¸ä»¥é˜²è´´è¾¹ */
            font-size: clamp(2.4rem, 9.5vmin, 5rem); 
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
            line-height: 1;
            /* æœ‰äº› Emoji å­—ä½“æœ¬èº«é‡å¿ƒåé«˜ï¼Œå¢åŠ ä¸€ç‚¹é¡¶éƒ¨å†…è¾¹è·æ¥è§†è§‰å±…ä¸­ */
            padding-top: 5%; 
        }

        /* å‡å˜é€‰é¡¹ */
        .promo-option {
            font-size: 3rem;
            transition: transform 0.1s;
        }
        .promo-option:active { transform: scale(0.9); }

        .hidden { display: none !important; }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .modal-content { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="flex flex-col items-center safe-area-top safe-area-bottom">

    <!-- ä¸»èœå• -->
    <div id="main-menu" class="w-full h-full flex flex-col items-center justify-center p-6 space-y-8 z-10">
        <div class="text-center space-y-3">
            <h1 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-teal-200 to-cyan-400 tracking-tight drop-shadow-sm">
                æ£‹ä¹æ— ç©·
            </h1>
            <p class="text-xl text-slate-400 font-bold">Judy & Nick çš„å¯¹å¼ˆæ—¶å…‰</p>
        </div>

        <div class="glass-panel p-8 w-full max-w-md space-y-6">
            <div class="text-center mb-6 flex justify-center gap-6">
                <span class="text-6xl filter drop-shadow-lg">ğŸ°</span> 
                <span class="text-4xl flex items-center text-slate-500 font-black">VS</span>
                <span class="text-6xl filter drop-shadow-lg">ğŸ¦Š</span>
            </div>
            
            <button onclick="setupGame('gobang')" class="btn-game w-full bg-gradient-to-r from-emerald-500 to-teal-500 text-white py-4 rounded-xl text-xl font-bold shadow-lg shadow-emerald-500/20 flex items-center justify-center space-x-3">
                <span class="text-2xl">âš«âšª</span>
                <span>äº”å­æ£‹ (Gobang)</span>
            </button>
            
            <button onclick="setupGame('chess')" class="btn-game w-full bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white py-4 rounded-xl text-xl font-bold shadow-lg shadow-violet-500/20 flex items-center justify-center space-x-3">
                <span class="text-2xl">â™Ÿï¸</span>
                <span>å›½é™…è±¡æ£‹ (Chess)</span>
            </button>
        </div>
    </div>

    <!-- æ¸¸æˆè®¾ç½®ç•Œé¢ -->
    <div id="setup-screen" class="hidden w-full h-full flex flex-col items-center justify-center p-6 z-10">
        <div class="glass-panel p-8 w-full max-w-md space-y-6">
            <h2 id="setup-title" class="text-3xl font-bold text-center text-white">æ¸¸æˆè®¾ç½®</h2>
            
            <div class="space-y-3">
                <label class="block text-slate-300 font-bold text-sm uppercase tracking-wide">å¯¹æˆ˜æ¨¡å¼</label>
                <div class="flex space-x-4">
                    <button id="mode-pve" onclick="selectMode('pve')" class="flex-1 py-4 rounded-xl border border-teal-500 bg-teal-500/20 text-teal-300 font-bold transition-all">äººæœº (AI)</button>
                    <button id="mode-pvp" onclick="selectMode('pvp')" class="flex-1 py-4 rounded-xl border border-slate-600 bg-slate-700/30 text-slate-400 font-bold transition-all">åŒäºº (2P)</button>
                </div>
            </div>

            <!-- è§’è‰²é€‰æ‹© (ä»… PVE æ˜¾ç¤º) -->
            <div id="char-selector" class="space-y-3">
                <label class="block text-slate-300 font-bold text-sm uppercase tracking-wide">é€‰æ‹©ä½ çš„è§’è‰²</label>
                <div class="flex space-x-4">
                    <button id="char-judy" onclick="selectChar('judy')" class="flex-1 py-3 rounded-xl border border-teal-500 bg-teal-500/20 text-white font-bold transition-all flex items-center justify-center gap-2">
                        <span class="text-2xl">ğŸ°</span> æœ±è¿ª
                    </button>
                    <button id="char-nick" onclick="selectChar('nick')" class="flex-1 py-3 rounded-xl border border-slate-600 bg-slate-700/30 text-slate-400 font-bold transition-all flex items-center justify-center gap-2">
                        <span class="text-2xl">ğŸ¦Š</span> å°¼å…‹
                    </button>
                </div>
            </div>

            <div id="difficulty-selector" class="space-y-3">
                <label class="block text-slate-300 font-bold text-sm uppercase tracking-wide">AI éš¾åº¦</label>
                <select id="difficulty" class="w-full p-4 rounded-xl bg-slate-700/50 border border-slate-600 text-white text-lg outline-none focus:border-teal-500">
                    <option value="easy">ç®€å• (å®ä¹ ç”Ÿ)</option>
                    <option value="medium" selected>ä¸­ç­‰ (è­¦å‘˜)</option>
                    <option value="hard">å›°éš¾ (å±€é•¿)</option>
                </select>
            </div>
            
            <div class="pt-6 flex space-x-4">
                <button onclick="goBack('main')" class="flex-1 py-3 rounded-xl bg-slate-700 text-slate-300 font-bold">è¿”å›</button>
                <button onclick="startDicePhase()" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-bold shadow-lg shadow-cyan-500/20">å¼€å§‹æ¸¸æˆ</button>
            </div>
        </div>
    </div>

    <!-- æ·éª°å­å¼¹çª— -->
    <div id="dice-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="modal-content glass-panel p-8 w-80 text-center space-y-6">
            <h3 class="text-xl font-bold text-white">æ·éª°å­å®šå…ˆæ‰‹</h3>
            <div class="flex justify-around items-center">
                <div class="text-center">
                    <div id="dice-p1-icon-show" class="text-4xl mb-2">ğŸ°</div>
                    <div id="dice-p1" class="text-3xl font-mono font-bold text-teal-400">-</div>
                </div>
                <div class="text-slate-500 font-bold">VS</div>
                <div class="text-center">
                    <div id="dice-p2-icon-show" class="text-4xl mb-2">ğŸ¤–</div>
                    <div id="dice-p2" class="text-3xl font-mono font-bold text-rose-400">-</div>
                </div>
            </div>
            <p id="dice-msg" class="text-sm text-slate-400 h-6">å‡†å¤‡æ·éª°å­...</p>
            <button id="roll-btn" onclick="rollDiceAnim()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg">æ·éª°å­</button>
        </div>
    </div>
    
    <!-- å‡å˜å¼¹çª— -->
    <div id="promotion-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="modal-content glass-panel p-6 w-80 text-center space-y-4">
            <h3 class="text-xl font-bold text-white">å…µå‡å˜</h3>
            <p class="text-slate-300 text-sm">é€‰æ‹©ä½ çš„æ–°æ£‹å­</p>
            <div class="grid grid-cols-2 gap-4" id="promo-options">
                <!-- é€‰é¡¹å°†é€šè¿‡ JS ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="game-screen" class="hidden w-full h-full flex flex-col items-center relative">
        <div class="w-full flex justify-between items-center px-4 py-3 glass-panel rounded-none border-t-0 border-x-0 z-20 shrink-0">
            <button onclick="confirmExit()" class="text-sm bg-slate-700 hover:bg-red-500/20 hover:text-red-400 px-4 py-2 rounded-lg font-bold text-slate-300 transition-colors">é€€å‡º</button>
            <div class="flex items-center space-x-6">
                <!-- P1 -->
                <div id="p1-indicator" class="flex flex-col items-center transition-opacity duration-300 opacity-100">
                    <div class="w-10 h-10 rounded-full bg-white text-black flex items-center justify-center text-xl shadow-lg border-2 border-emerald-400 relative">
                        <span id="p1-avatar-game">ğŸ°</span>
                        <div id="p1-turn-dot" class="absolute -bottom-1 -right-1 w-3 h-3 bg-emerald-500 rounded-full hidden"></div>
                    </div>
                </div>
                <div class="flex flex-col items-center">
                    <div class="text-slate-500 font-black text-xs tracking-widest">VS</div>
                    <div id="timer" class="text-xs text-slate-400 font-mono mt-1">00:00</div>
                </div>
                <!-- P2 -->
                <div id="p2-indicator" class="flex flex-col items-center transition-opacity duration-300 opacity-50">
                    <div id="p2-indicator-bg" class="w-10 h-10 rounded-full bg-slate-700 text-white flex items-center justify-center text-xl shadow-lg border-2 border-transparent relative">
                        <span id="p2-avatar-game">ğŸ¤–</span>
                        <div id="p2-turn-dot" class="absolute -bottom-1 -right-1 w-3 h-3 bg-emerald-500 rounded-full hidden"></div>
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <button id="hint-toggle-btn" onclick="toggleHints()" class="hidden text-sm bg-slate-700 hover:bg-yellow-500/20 hover:text-yellow-300 px-3 py-2 rounded-lg font-bold text-slate-300 transition-colors">ğŸ’¡</button>
                <button onclick="undoMove()" class="text-sm bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded-lg font-bold text-amber-400 transition-colors">â†©ï¸</button>
                <button onclick="restartGame()" class="text-sm bg-slate-700 hover:bg-indigo-600/30 hover:text-indigo-300 px-3 py-2 rounded-lg font-bold text-slate-300 transition-colors">â†»</button>
            </div>
        </div>

        <div class="flex-1 w-full flex items-center justify-center p-1 overflow-hidden">
            <div id="board-container" class="relative transition-all duration-300"></div>
        </div>

        <div class="w-full p-4 pb-8 text-center glass-panel rounded-none border-b-0 border-x-0 shrink-0">
            <span id="game-status" class="text-emerald-400 font-bold text-lg animate-pulse">ç­‰å¾…å¼€å§‹...</span>
        </div>
    </div>

    <!-- ç»“ç®—å¼¹çª— -->
    <div id="result-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="modal-content glass-panel p-8 w-80 text-center space-y-6 border border-white/20">
            <div class="text-7xl mb-4" id="winner-icon">ğŸ†</div>
            <h2 class="text-3xl font-black text-white" id="winner-text">æ¸¸æˆç»“æŸ</h2>
            <p class="text-slate-300" id="winner-sub">èƒœåˆ©å±äºæœ±è¿ªï¼</p>
            <div class="flex space-x-3">
                <button onclick="confirmExit()" class="flex-1 py-3 bg-slate-700 text-slate-300 rounded-xl font-bold">ä¸»é¡µ</button>
                <button onclick="startDicePhase()" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-bold shadow-lg shadow-emerald-500/30">å†æ¥ä¸€å±€</button>
            </div>
        </div>
    </div>

    <script>
        const state = {
            gameType: null, mode: 'pve', difficulty: 'medium', userChar: 'judy',
            currentPlayer: 1, startPlayer: 1, board: [], history: [],
            gameOver: false, aiThinking: false, timer: 0, timerInterval: null,
            showHints: false, lastMove: null, lastMoveTime: 0, pendingPromotion: null 
        };
        const config = { 
            gobangSize: 15, 
            icons: { 
                judy: 'ğŸ°', 
                nick: 'ğŸ¦Š', 
                robot: 'ğŸ¤–' 
            } 
        };

        function setupGame(type) {
            state.gameType = type;
            const mainMenu = document.getElementById('main-menu');
            const setupScreen = document.getElementById('setup-screen');
            const setupTitle = document.getElementById('setup-title');
            
            if(mainMenu && setupScreen && setupTitle) {
                mainMenu.classList.add('hidden');
                setupScreen.classList.remove('hidden');
                setupTitle.innerText = type === 'gobang' ? 'äº”å­æ£‹è®¾ç½®' : 'å›½é™…è±¡æ£‹è®¾ç½®';
                selectMode('pve');
                selectChar('judy');
            }
        }

        function selectMode(mode) {
            state.mode = mode;
            const btnPve = document.getElementById('mode-pve');
            const btnPvp = document.getElementById('mode-pvp');
            const charSelector = document.getElementById('char-selector');
            const diffSelector = document.getElementById('difficulty-selector');

            if(mode === 'pve') {
                btnPve.className = "flex-1 py-4 rounded-xl border border-teal-500 bg-teal-500/20 text-teal-300 font-bold transition-all";
                btnPvp.className = "flex-1 py-4 rounded-xl border border-slate-600 bg-slate-700/30 text-slate-400 font-bold transition-all";
                charSelector.classList.remove('hidden');
                diffSelector.classList.remove('hidden');
            } else {
                btnPve.className = "flex-1 py-4 rounded-xl border border-slate-600 bg-slate-700/30 text-slate-400 font-bold transition-all";
                btnPvp.className = "flex-1 py-4 rounded-xl border border-teal-500 bg-teal-500/20 text-teal-300 font-bold transition-all";
                charSelector.classList.add('hidden');
                diffSelector.classList.add('hidden');
            }
        }

        function selectChar(char) {
            state.userChar = char;
            const btnJudy = document.getElementById('char-judy');
            const btnNick = document.getElementById('char-nick');
            
            if(char === 'judy') {
                btnJudy.className = "flex-1 py-3 rounded-xl border border-teal-500 bg-teal-500/20 text-white font-bold transition-all flex items-center justify-center gap-2";
                btnNick.className = "flex-1 py-3 rounded-xl border border-slate-600 bg-slate-700/30 text-slate-400 font-bold transition-all flex items-center justify-center gap-2";
            } else {
                btnJudy.className = "flex-1 py-3 rounded-xl border border-slate-600 bg-slate-700/30 text-slate-400 font-bold transition-all flex items-center justify-center gap-2";
                btnNick.className = "flex-1 py-3 rounded-xl border border-teal-500 bg-teal-500/20 text-white font-bold transition-all flex items-center justify-center gap-2";
            }
        }

        function goBack(target) {
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
        }

        function startDicePhase() {
            state.difficulty = document.getElementById('difficulty').value;
            document.getElementById('result-modal').classList.add('hidden');
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('dice-modal').classList.remove('hidden');
            document.getElementById('roll-btn').classList.remove('hidden');
            
            let p1Icon, p2Icon;
            if(state.mode === 'pve') {
                p1Icon = state.userChar === 'judy' ? config.icons.judy : config.icons.nick;
                p2Icon = config.icons.robot;
            } else {
                p1Icon = config.icons.judy;
                p2Icon = config.icons.nick;
            }

            document.getElementById('dice-p1-icon-show').innerText = p1Icon;
            document.getElementById('dice-p2-icon-show').innerText = p2Icon;
            document.getElementById('dice-p1').innerText = '-';
            document.getElementById('dice-p2').innerText = '-';
            document.getElementById('dice-msg').innerText = "ç‚¹æ•°å¤§çš„å…ˆè¡Œ";
        }

        function rollDiceAnim() {
            document.getElementById('roll-btn').classList.add('hidden');
            document.getElementById('dice-msg').innerText = "æ·éª°å­ä¸­...";
            let rolls = 0;
            const interval = setInterval(() => {
                document.getElementById('dice-p1').innerText = Math.floor(Math.random()*6)+1;
                document.getElementById('dice-p2').innerText = Math.floor(Math.random()*6)+1;
                rolls++;
                if(rolls > 10) { clearInterval(interval); finalizeDice(); }
            }, 100);
        }

        function finalizeDice() {
            let d1 = Math.floor(Math.random()*6)+1;
            let d2 = Math.floor(Math.random()*6)+1;
            while(d1 === d2) { d2 = Math.floor(Math.random()*6)+1; }
            document.getElementById('dice-p1').innerText = d1;
            document.getElementById('dice-p2').innerText = d2;
            state.startPlayer = d1 > d2 ? 1 : 2;
            
            let winnerName = "";
            if(state.mode === 'pve') {
                if(state.startPlayer === 1) winnerName = state.userChar === 'judy' ? 'æœ±è¿ª' : 'å°¼å…‹';
                else winnerName = 'ç”µè„‘';
            } else {
                winnerName = state.startPlayer === 1 ? 'æœ±è¿ª' : 'å°¼å…‹';
            }
            
            document.getElementById('dice-msg').innerText = `${winnerName} å…ˆæ‰‹ï¼`;
            setTimeout(() => {
                document.getElementById('dice-modal').classList.add('hidden');
                startGame();
            }, 1500);
        }

        function startGame() {
            document.getElementById('game-screen').classList.remove('hidden');
            
            let p1Icon, p2Icon;
            if(state.mode === 'pve') {
                p1Icon = state.userChar === 'judy' ? config.icons.judy : config.icons.nick;
                p2Icon = config.icons.robot;
            } else {
                p1Icon = config.icons.judy;
                p2Icon = config.icons.nick;
            }
            document.getElementById('p1-avatar-game').innerText = p1Icon;
            document.getElementById('p2-avatar-game').innerText = p2Icon;

            const hintBtn = document.getElementById('hint-toggle-btn');
            hintBtn.classList.toggle('hidden', state.gameType !== 'chess');
            state.showHints = false;
            updateHintButton();
            initBoard();
        }

        function toggleHints() {
            state.showHints = !state.showHints;
            updateHintButton();
            if(state.gameType === 'chess' && selectedSquare) renderHints(selectedSquare.x, selectedSquare.y);
        }
        function updateHintButton() {
            const btn = document.getElementById('hint-toggle-btn');
            btn.className = state.showHints ? "text-sm bg-yellow-500 text-white px-3 py-2 rounded-lg font-bold transition-colors" : "text-sm bg-slate-700 hover:bg-yellow-500/20 hover:text-yellow-300 px-3 py-2 rounded-lg font-bold text-slate-300 transition-colors";
        }
        function confirmExit() {
            if(state.timerInterval) clearInterval(state.timerInterval);
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-modal').classList.add('hidden');
            document.getElementById('promotion-modal').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
            state.gameOver = false;
        }
        function restartGame() { if(confirm("ç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿ")) startDicePhase(); }
        function startTimer() {
            if(state.timerInterval) clearInterval(state.timerInterval);
            state.timer = 0;
            const el = document.getElementById('timer');
            state.timerInterval = setInterval(() => {
                state.timer++;
                el.innerText = `${Math.floor(state.timer / 60).toString().padStart(2, '0')}:${(state.timer % 60).toString().padStart(2, '0')}`;
            }, 1000);
        }
        function initBoard() {
            state.gameOver = false; state.currentPlayer = state.startPlayer; state.aiThinking = false;
            state.history = []; state.lastMove = null; state.pendingPromotion = null;
            const container = document.getElementById('board-container');
            container.innerHTML = '';
            startTimer();
            if(state.gameType === 'gobang') initGobang(container); else initChess(container);
            updateTurnIndicator();
            if(state.mode === 'pve' && state.currentPlayer === 2) {
                state.aiThinking = true;
                updateTurnIndicator();
                setTimeout(() => { state.gameType === 'gobang' ? aiGobangMove() : aiChessMove(); }, 1000);
            }
        }
        function updateTurnIndicator() {
            const p1Ind = document.getElementById('p1-indicator');
            const p2Ind = document.getElementById('p2-indicator');
            const p1Dot = document.getElementById('p1-turn-dot');
            const p2Dot = document.getElementById('p2-turn-dot');
            const status = document.getElementById('game-status');
            const p2Bg = document.getElementById('p2-indicator-bg');
            
            let p1Name = state.mode==='pve' ? (state.userChar==='judy'?'æœ±è¿ª':'å°¼å…‹') : 'æœ±è¿ª';
            let p2Name = state.mode==='pve' ? 'ç”µè„‘' : 'å°¼å…‹';

            if(state.currentPlayer === 1) {
                p1Ind.style.opacity = '1'; p1Dot.classList.remove('hidden');
                p2Ind.style.opacity = '0.5'; p2Dot.classList.add('hidden');
                p2Bg.classList.remove('border-emerald-400', 'border-2'); p2Bg.classList.add('border-transparent');
                status.innerText = `è½®åˆ° ${p1Name} è½å­...`; status.className = "text-emerald-400 font-bold text-lg animate-pulse";
            } else {
                p1Ind.style.opacity = '0.5'; p1Dot.classList.add('hidden');
                p2Ind.style.opacity = '1'; p2Dot.classList.remove('hidden');
                p2Bg.classList.remove('border-transparent'); p2Bg.classList.add('border-emerald-400', 'border-2');
                status.innerText = state.aiThinking ? `${p2Name} æ­£åœ¨æ€è€ƒ...` : `è½®åˆ° ${p2Name} è½å­...`;
                status.className = "text-rose-400 font-bold text-lg animate-pulse";
            }
        }
        function showWinner(winner) {
            state.gameOver = true;
            if(state.timerInterval) clearInterval(state.timerInterval);
            const modal = document.getElementById('result-modal');
            modal.classList.remove('hidden');
            
            let icon = '', text = '', sub = '';
            
            if(winner === 1) {
                if(state.mode === 'pve') {
                    icon = state.userChar === 'judy' ? config.icons.judy : config.icons.nick;
                    text = (state.userChar === 'judy' ? 'æœ±è¿ª' : 'å°¼å…‹') + 'èƒœåˆ©ï¼';
                } else {
                    icon = config.icons.judy;
                    text = 'æœ±è¿ªèƒœåˆ©ï¼';
                }
                sub = 'å®Œç¾çš„ç­–ç•¥ï¼';
                document.getElementById('winner-text').className = "text-3xl font-black text-emerald-400";
            } else if (winner === 2) {
                icon = state.mode === 'pve' ? config.icons.robot : config.icons.nick;
                text = state.mode === 'pve' ? 'AI èƒœåˆ©ï¼' : 'å°¼å…‹èƒœåˆ©ï¼';
                sub = state.mode === 'pve' ? 'äººç±»è¿˜éœ€è¦è¿›åŒ–ã€‚' : 'ç‹¡çŒ¾çš„ç‹ç‹¸èµ¢äº†ï¼';
                document.getElementById('winner-text').className = "text-3xl font-black text-rose-400";
            } else {
                icon = 'ğŸ¤'; text = 'å¹³å±€'; sub = 'æ——é¼“ç›¸å½“çš„å¯¹æ‰‹ã€‚';
                document.getElementById('winner-text').className = "text-3xl font-black text-slate-200";
            }

            document.getElementById('winner-icon').innerText = icon;
            document.getElementById('winner-text').innerText = text;
            document.getElementById('winner-sub').innerText = sub;
        }

        // --- Gobang Logic ---
        function initGobang(container, resetState = true) {
            if(resetState) state.board = Array(15).fill().map(() => Array(15).fill(0));
            const boardEl = document.createElement('div');
            boardEl.className = 'gobang-board';
            const starPoints = ['3,3', '11,3', '7,7', '3,11', '11,11'];
            for(let y=0; y<15; y++) {
                for(let x=0; x<15; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'gobang-cell';
                    cell.onclick = () => handleGobangClick(x, y);
                    if(starPoints.includes(`${x},${y}`)) {
                        const star = document.createElement('div');
                        star.className = 'gobang-star-point';
                        cell.appendChild(star);
                    }
                    if(state.board[y][x] !== 0) renderGobangPieceInCell(cell, state.board[y][x], false);
                    boardEl.appendChild(cell);
                }
            }
            container.appendChild(boardEl);
        }
        function handleGobangClick(x, y) {
            if(state.gameOver || state.board[y][x] !== 0 || state.aiThinking) return;
            saveState();
            state.board[y][x] = state.currentPlayer;
            state.lastMove = {x, y};
            state.lastMoveTime = Date.now();
            renderGobangPieceInCell(document.querySelectorAll('.gobang-cell')[y*15+x], state.currentPlayer, true);
            if(checkGobangWin(x, y, state.currentPlayer)) { setTimeout(() => showWinner(state.currentPlayer), 300); return; }
            state.currentPlayer = state.currentPlayer === 1 ? 2 : 1;
            updateTurnIndicator();
            if(state.mode === 'pve' && state.currentPlayer === 2) {
                state.aiThinking = true; updateTurnIndicator(); setTimeout(aiGobangMove, 500);
            }
        }
        function renderGobangPieceInCell(cell, player, animate) {
            // Determine class based on player and settings
            let cls = '';
            let icon = '';
            
            if(player === 1) { // Player 1
                if(state.mode === 'pve' && state.userChar === 'nick') {
                    cls = 'gb-orange'; icon = config.icons.nick;
                } else {
                    cls = 'gb-white'; icon = config.icons.judy;
                }
            } else { // Player 2
                if(state.mode === 'pve') {
                    cls = 'gb-black'; icon = config.icons.robot;
                } else {
                    // PvP Player 2 is Nick
                    cls = 'gb-orange'; icon = config.icons.nick;
                }
            }

            const piece = document.createElement('div');
            piece.className = `gobang-piece ${cls} last-move-marker`;
            piece.innerText = icon;

            document.querySelectorAll('.last-move-marker').forEach(el => el.classList.remove('last-move-marker'));
            piece.classList.add('last-move-marker');
            if(animate) { piece.style.transform = 'scale(0)'; cell.appendChild(piece); setTimeout(() => piece.style.transform = 'scale(1)', 50); }
            else cell.appendChild(piece);
        }
        function checkGobangWin(x, y, player) {
            const dirs = [[1,0], [0,1], [1,1], [1,-1]];
            for(let d of dirs) {
                let count = 1;
                for(let i=1; i<5; i++) { let nx=x+d[0]*i, ny=y+d[1]*i; if(nx>=0&&nx<15&&ny>=0&&ny<15&&state.board[ny][nx]===player) count++; else break; }
                for(let i=1; i<5; i++) { let nx=x-d[0]*i, ny=y-d[1]*i; if(nx>=0&&nx<15&&ny>=0&&ny<15&&state.board[ny][nx]===player) count++; else break; }
                if(count >= 5) return true;
            }
            return false;
        }
        function aiGobangMove() {
            saveState();
            let bestMove = null;
            if(state.difficulty === 'easy' && Math.random() < 0.3) {
                const empties = []; for(let y=0; y<15; y++) for(let x=0; x<15; x++) if(state.board[y][x]===0) empties.push({x,y});
                bestMove = empties[Math.floor(Math.random() * empties.length)];
            } else bestMove = getBestMoveGobang(state.board, 2);
            state.board[bestMove.y][bestMove.x] = 2;
            state.lastMove = bestMove;
            state.lastMoveTime = Date.now();
            renderGobangPieceInCell(document.querySelectorAll('.gobang-cell')[bestMove.y*15+bestMove.x], 2, true);
            if(checkGobangWin(bestMove.x, bestMove.y, 2)) { setTimeout(() => showWinner(2), 300); }
            else { state.currentPlayer = 1; state.aiThinking = false; updateTurnIndicator(); }
        }
        function getBestMoveGobang(board, player) {
            let candidates = [];
            for(let y=0; y<15; y++) {
                for(let x=0; x<15; x++) {
                    if(board[y][x] !== 0) continue;
                    let hasNeighbor = false;
                    for(let dy=-1; dy<=1; dy++) for(let dx=-1; dx<=1; dx++) { if(dx||dy) { let nx=x+dx,ny=y+dy; if(nx>=0&&nx<15&&ny>=0&&ny<15&&board[ny][nx]!==0) hasNeighbor=true; } }
                    if(hasNeighbor || (x===7&&y===7)) {
                        let score = evaluateGobang(board, x, y, player) + evaluateGobang(board, x, y, player===1?2:1) * (state.difficulty === 'hard' ? 1.1 : 0.9);
                        candidates.push({x, y, score});
                    }
                }
            }
            if(candidates.length === 0) return {x: 7, y: 7};
            candidates.sort((a,b) => b.score - a.score);
            return candidates[0];
        }
        function evaluateGobang(board, x, y, player) {
            let total = 0; board[y][x] = player;
            const lines = [[1,0],[0,1],[1,1],[1,-1]];
            for(let d of lines) {
                let s = '';
                for(let i=-4; i<=4; i++) {
                    let nx=x+d[0]*i, ny=y+d[1]*i;
                    s += (nx>=0&&nx<15&&ny>=0&&ny<15) ? (board[ny][nx]===player?'P':(board[ny][nx]===0?'_':'O')) : 'O';
                }
                if(s.includes('PPPPP')) total += 100000;
                else if(s.includes('_PPPP_')) total += 10000;
                else if(s.includes('PPPP_')||s.includes('_PPPP')) total += 2500;
                else if(s.includes('_PPP_')) total += 3000;
                else if(s.includes('PPP_')||s.includes('_PPP')) total += 500;
                else if(s.includes('_PP_')) total += 200;
            }
            board[y][x] = 0; return total;
        }

        // --- Chess Logic ---
        const INITIAL_CHESS = [[-2,-3,-4,-5,-6,-4,-3,-2],[-1,-1,-1,-1,-1,-1,-1,-1],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,1],[2,3,4,5,6,4,3,2]];
        let selectedSquare = null;

        function initChess(container) {
            const boardEl = document.createElement('div');
            boardEl.className = 'chess-board';
            state.board = JSON.parse(JSON.stringify(INITIAL_CHESS));
            selectedSquare = null;
            renderChessBoard(boardEl);
            container.appendChild(boardEl);
        }

        function getChessPieceChar(type) {
            const map = { 1: 'â™Ÿ\uFE0E', 2: 'â™œ\uFE0E', 3: 'â™\uFE0E', 4: 'â™\uFE0E', 5: 'â™›\uFE0E', 6: 'â™š\uFE0E' };
            return map[type];
        }

        function renderChessBoard(boardEl) {
            boardEl.innerHTML = '';
            // è®¡ç®—åŠ¨ç”»æµé€æ—¶é—´
            const timeElapsed = Date.now() - state.lastMoveTime;
            const showLastMove = state.lastMove && timeElapsed < 3000;

            for(let y=0; y<8; y++) for(let x=0; x<8; x++) {
                const sq = document.createElement('div');
                sq.className = `chess-square ${(x+y)%2===0 ? 'white' : 'black'}`;
                if(selectedSquare && selectedSquare.x===x && selectedSquare.y===y) sq.classList.add('selected');
                
                // Last Move Logic with Timestamp check
                if(showLastMove && ((state.lastMove.fx===x && state.lastMove.fy===y) || (state.lastMove.tx===x && state.lastMove.ty===y))) {
                    sq.classList.add('last-move');
                    // Sync Animation
                    sq.style.setProperty('--delay', `-${timeElapsed}ms`);
                    // Use a style block or inline style for negative delay to sync
                    // Note: In CSS above I didn't add --delay var, let's fix inline style logic or just let it play.
                    // To strictly sync: animation-delay: -elapsed ms.
                    // But standard CSS animation restarts on DOM insertion. 
                    // To visually sync, we must set animation-delay.
                    // However, simplified approach: if < 3s, just show it.
                    // To prevent "jump", we can try to compute the opacity manually, OR set negative delay.
                    // Adding style directly for simplicity
                    const style = document.createElement('style');
                    style.innerHTML = `.chess-square.last-move::before { animation-delay: -${timeElapsed}ms; }`;
                    sq.appendChild(style);
                }
                
                const val = state.board[y][x];
                if(val !== 0) {
                    const type = Math.abs(val);
                    const isWhite = val > 0;
                    const piece = document.createElement('div');
                    
                    let styleClass = '';
                    let content = '';
                    let isKing = (type === 6);

                    if(isWhite) { 
                        if(state.mode === 'pve' && state.userChar === 'nick') {
                            styleClass = isKing ? 'chess-emoji-king' : 'chess-piece orange-side';
                            content = isKing ? config.icons.nick : getChessPieceChar(type);
                        } else {
                            styleClass = isKing ? 'chess-emoji-king' : 'chess-piece white-side';
                            content = isKing ? config.icons.judy : getChessPieceChar(type);
                        }
                    } else { 
                        if(state.mode === 'pve') {
                            styleClass = isKing ? 'chess-emoji-king' : 'chess-piece black-side';
                            content = isKing ? config.icons.robot : getChessPieceChar(type);
                        } else {
                            styleClass = isKing ? 'chess-emoji-king' : 'chess-piece orange-side';
                            content = isKing ? config.icons.nick : getChessPieceChar(type);
                        }
                    }

                    piece.className = styleClass;
                    piece.innerText = content;
                    sq.appendChild(piece);
                }
                sq.onclick = () => handleChessClick(x, y);
                boardEl.appendChild(sq);
            }
            if(selectedSquare && state.showHints) renderHints(selectedSquare.x, selectedSquare.y);
        }

        function refreshChessUI() {
            const boardEl = document.querySelector('.chess-board');
            if(boardEl) renderChessBoard(boardEl);
        }

        function renderHints(x, y) {
            const boardEl = document.querySelector('.chess-board');
            for(let ty=0; ty<8; ty++) for(let tx=0; tx<8; tx++) {
                if(isValidMove(x, y, tx, ty, state.board)) {
                    const hint = document.createElement('div');
                    hint.className = state.board[ty][tx] !== 0 ? 'hint-capture' : 'hint-dot';
                    boardEl.children[ty*8+tx].appendChild(hint);
                }
            }
        }

        function handleChessClick(x, y) {
            if(state.gameOver || state.aiThinking || state.pendingPromotion) return;
            const val = state.board[y][x];
            const isOwn = state.currentPlayer === 1 ? val > 0 : val < 0;
            if(isOwn) { selectedSquare = {x, y}; refreshChessUI(); }
            else if(selectedSquare && isValidMove(selectedSquare.x, selectedSquare.y, x, y, state.board)) {
                if(Math.abs(state.board[selectedSquare.y][selectedSquare.x]) === 1 && (y === 0 || y === 7)) {
                    state.pendingPromotion = {fx: selectedSquare.x, fy: selectedSquare.y, tx: x, ty: y};
                    showPromotionModal(state.currentPlayer);
                } else {
                    executeChessMove(selectedSquare.x, selectedSquare.y, x, y);
                }
            }
        }

        function showPromotionModal(player) {
            const modal = document.getElementById('promotion-modal');
            const options = document.getElementById('promo-options');
            modal.classList.remove('hidden');
            options.innerHTML = '';
            const pieces = [5, 2, 3, 4];
            const names = ['å', 'è½¦', 'é©¬', 'è±¡'];
            
            let colorClass = '';
            if(player === 1) {
                colorClass = (state.mode==='pve' && state.userChar==='nick') ? 'text-orange-500 drop-shadow-md' : 'text-white drop-shadow-md';
            } else {
                colorClass = (state.mode==='pve') ? 'text-slate-900 drop-shadow-md' : 'text-orange-500 drop-shadow-md';
            }

            pieces.forEach((p, i) => {
                const btn = document.createElement('button');
                btn.className = "p-4 glass-panel hover:bg-white/20 rounded-xl flex flex-col items-center justify-center promo-option";
                const char = getChessPieceChar(p);
                btn.innerHTML = `<span class="${colorClass}">${char}</span><span class="text-white font-bold text-sm mt-2">${names[i]}</span>`;
                btn.onclick = () => completePromotion(p);
                options.appendChild(btn);
            });
        }

        function completePromotion(type) {
            const m = state.pendingPromotion;
            saveState();
            state.board[m.ty][m.tx] = state.currentPlayer === 1 ? type : -type;
            state.board[m.fy][m.fx] = 0;
            state.lastMove = m;
            state.lastMoveTime = Date.now();
            state.pendingPromotion = null;
            document.getElementById('promotion-modal').classList.add('hidden');
            finishChessTurn();
        }

        function executeChessMove(fx, fy, tx, ty) {
            saveState();
            state.board[ty][tx] = state.board[fy][fx];
            state.board[fy][fx] = 0;
            state.lastMove = {fx, fy, tx, ty};
            state.lastMoveTime = Date.now();
            finishChessTurn();
        }

        function finishChessTurn() {
            selectedSquare = null;
            refreshChessUI();
            if(!hasKing(state.board, state.currentPlayer === 1 ? 2 : 1)) { showWinner(state.currentPlayer); return; }
            state.currentPlayer = state.currentPlayer === 1 ? 2 : 1;
            updateTurnIndicator();
            if(state.mode === 'pve' && state.currentPlayer === 2) {
                state.aiThinking = true; updateTurnIndicator(); setTimeout(aiChessMove, 500);
            }
        }

        function isValidMove(fx, fy, tx, ty, board) {
            const p = board[fy][fx], target = board[ty][tx], type = Math.abs(p);
            const dx = tx-fx, dy = ty-fy, adx = Math.abs(dx), ady = Math.abs(dy);
            if(target !== 0 && ((p>0 && target>0) || (p<0 && target<0))) return false;
            if(type === 1) { // Pawn
                const dir = p > 0 ? -1 : 1;
                if(dx === 0 && target === 0) {
                    if(dy === dir) return true;
                    if(fy === (p>0?6:1) && dy === 2*dir && board[fy+dir][fx] === 0) return true;
                }
                if(adx === 1 && dy === dir && target !== 0) return true;
                return false;
            }
            if(type === 2) return (dx===0 || dy===0) && isPathClear(fx, fy, tx, ty, board);
            if(type === 3) return (adx===1 && ady===2) || (adx===2 && ady===1);
            if(type === 4) return (adx===ady) && isPathClear(fx, fy, tx, ty, board);
            if(type === 5) return (dx===0 || dy===0 || adx===ady) && isPathClear(fx, fy, tx, ty, board);
            if(type === 6) return adx<=1 && ady<=1;
            return false;
        }
        function isPathClear(fx, fy, tx, ty, board) {
            const sx = Math.sign(tx-fx), sy = Math.sign(ty-fy);
            let x = fx+sx, y = fy+sy;
            while(x !== tx || y !== ty) { if(board[y][x] !== 0) return false; x+=sx; y+=sy; }
            return true;
        }
        function hasKing(board, player) {
            const k = player===1?6:-6;
            for(let r of board) if(r.includes(k)) return true;
            return false;
        }

        // --- Chess AI ---
        function aiChessMove() {
            // Check for AI promotion
            const moves = [];
            for(let y=0; y<8; y++) for(let x=0; x<8; x++) if(state.board[y][x] < 0) {
                for(let ty=0; ty<8; ty++) for(let tx=0; tx<8; tx++) if(isValidMove(x, y, tx, ty, state.board)) moves.push({fx:x, fy:y, tx:tx, ty:ty});
            }
            if(moves.length === 0) { state.aiThinking = false; return; }
            
            let bestMove = moves[0], bestScore = -9999;
            if(state.difficulty === 'easy') {
                bestMove = moves[Math.floor(Math.random()*moves.length)];
            } else {
                for(let m of moves) {
                    let score = 0;
                    const target = Math.abs(state.board[m.ty][m.tx]);
                    if(target===6) score+=1000; else if(target===5) score+=90; else if(target===2) score+=50; else if(target===3||target===4) score+=30; else if(target===1) score+=10;
                    if(state.difficulty === 'hard' && isSquareUnderAttack(m.tx, m.ty, 1, state.board)) score -= Math.abs(state.board[m.fy][m.fx]) * 5;
                    if(score > bestScore) { bestScore = score; bestMove = m; }
                }
            }
            
            // Auto promote for AI
            const isPromo = Math.abs(state.board[bestMove.fy][bestMove.fx]) === 1 && bestMove.ty === 7;
            executeChessMove(bestMove.fx, bestMove.fy, bestMove.tx, bestMove.ty);
            if(isPromo) state.board[bestMove.ty][bestMove.tx] = -5; // Always Queen
        }
        function isSquareUnderAttack(tx, ty, attacker, board) {
            for(let y=0; y<8; y++) for(let x=0; x<8; x++) {
                const p = board[y][x];
                if((attacker===1 && p>0) || (attacker===2 && p<0)) {
                    if(isValidMove(x, y, tx, ty, board)) return true;
                }
            }
            return false;
        }
        
        // --- è¾…åŠ©åŠŸèƒ½ ---
        function undoMove() {
            if(state.gameOver || state.aiThinking || state.history.length === 0 || state.pendingPromotion) return;
            let steps = 1;
            if(state.mode === 'pve') {
                if(state.currentPlayer === 1 && state.history.length >= 2) steps = 2; else if (state.currentPlayer === 2) return;
            }
            for(let i=0; i<steps; i++) {
                if(state.history.length === 0) break;
                const prev = state.history.pop();
                restoreBoardState(prev);
                // Also restore timing to avoid re-triggering old animation if we undo
                state.lastMoveTime = 0; // Reset animation on undo
            }
            selectedSquare = null;
            refreshBoardUI();
            updateTurnIndicator();
        }
        function saveState() {
            state.history.push({
                board: JSON.parse(JSON.stringify(state.board)),
                player: state.currentPlayer,
                lastMove: state.lastMove ? {...state.lastMove} : null
            });
        }
        function restoreBoardState(saved) {
            state.board = saved.board;
            state.currentPlayer = saved.player;
            state.lastMove = saved.lastMove;
        }
        function refreshBoardUI() {
            const container = document.getElementById('board-container');
            if(state.gameType === 'gobang') { container.innerHTML = ''; initGobang(container, false); }
            else renderChessBoard(document.querySelector('.chess-board'));
        }
    </script>
</body>
</html>
